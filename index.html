<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--<meta http-equiv='cache-control' content='no-cache'> 
<meta http-equiv='expires' content='0'> 
<meta http-equiv='pragma' content='no-cache'>-->

<style>
  body {font-family: arial; }
  H2 {display: inline; }
  .button {background-color: #4CAF50; /* Green */
           border: none;
           color: white;
           padding: 2px 2px;
           text-align: center;
           text-decoration: none;
           display: inline-block;
           font-size: 16px;
           height: 30px; 
	   margin: 0px 0px;
           cursor: pointer;}
  .buttonwide {width: 25vw; 
	       min-width: 160px;}
  .buttonnarrow {width: 10vw; 
	         min-width: 100px;}
  .texmem {type: "text";
           text-align: center;
	  maxlength: 3;
          width: 15vw;
	  min-width: 5vw;
	  font-size: 24px;}
  .texgen {type: "text";
           text-align: center;
	   width: 15vw;
	   min-width: 120px;
	   font-size: 18px;}
  .texll {type: "text";
           text-align: center;
	   width: 12vw;
	   min-width: 80px;
	   font-size: 18px;}
</style>

<script type='text/javascript' // load BING map
  src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=ArPM1-wZaL7eXbyDyv75z434nDeiThBHD-TQnHqoxxQwFdYQEcxc_WdyUA6vGl2O' async defer>
</script>

<script type='text/javascript'> // detect mobile or desktop device
  function isMobile() {
    const regex = /Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
    return regex.test(navigator.userAgent); }	
  if (isMobile()) {console.log("Mobile device detected");
                   mobile = true;}
  else {console.log("Desktop device detected"); 
        mobile = false;}
  function reporttype() {
    if (mobile) {putmessage("Mobile device");}
    else {putmessage("Desktop device");} }
</script>

<script type='text/javascript'> // functions related to the interface

function share() {navigator.share({text: memcode});}
	
function test() {
    /* Get the text field */
    putmessage(memcode);
    let copyGfGText = document.getElementById("out_err");
    /* Select the text field */
    copyGfGText.select();
    /* Copy the text inside the text field */
    document.execCommand("copy");
    /* Use below command to access the 
       value of copied text */
    console.log("Copied " + copyGfGText.value);}

	
function GetMap() {
    map = new Microsoft.Maps.Map('#myMap');
    initloc = new Microsoft.Maps.Location(54.0, -2.0);
    map.setView({center: initloc,
                 zoom: 8 });
    Microsoft.Maps.Events.addHandler(map, 'click', // event handler for map click
				     function(e) {mapclick(e);} ); }

function mapclick(e) {console.log('Map clicked');
		     document.getElementById("out_lat").value = e.location.latitude.toFixed(5);		
	             document.getElementById("out_lon").value = e.location.longitude.toFixed(5);
                     encode(e.location.latitude, e.location.longitude);
                     document.getElementById("out_hex").value = hexcode;
		     putmem();
                     try {map.entities.remove(pin);} // delete old pin if it exists
                     catch {}
                     pin = new Microsoft.Maps.Pushpin(e.location,  // create pushpin
                                                      {title: memcode,
						       color: "green",
                                                       text: 'C'} );
                     map.entities.push(pin); }; // add to map
	
function clearmessage () {document.getElementById("out_err").value = "";}
function putmessage(text) {document.getElementById("out_err").value = text;}

function checkvalid(box) {
  tex = document.getElementById(box).value.toLowerCase();
  found = false;
  for (let j = 0; j < 256; j++) 
     {if (tex == words[j]) {found = true;} } 
  if (found) {return tex;}
  else {document.getElementById("out_err").value = tex + " not valid";
	valid = false;
        return "null";} }

function buildmem() {
  valid = true;
  c1 = checkvalid("t1");
  c2 = checkvalid("t2");
  c3 = checkvalid("t3");
  c4 = checkvalid("t4");
  c5 = checkvalid("t5");
  c6 = checkvalid("t6");
  if (valid) {memcode = c1 + "." + c2 + "." + c3 + "-" + c4 + "." + c5 + "." + c6;} }

function putmem() {
  document.getElementById("t1").value = memcode.substr(0,3);
  document.getElementById("t2").value = memcode.substr(4,3);
  document.getElementById("t3").value = memcode.substr(8,3);
  document.getElementById("t4").value = memcode.substr(12,3);
  document.getElementById("t5").value = memcode.substr(16,3);
  document.getElementById("t6").value = memcode.substr(20,3); }
 
function putonmap() {
  clearmessage();
  buildmem();
  if (!valid) {document.getElementById("out_err").value = "Location not found";
               return;}
  try {map.entities.remove(pincode);} // delete old pin if it exists
  catch {}
  decode(memcode);
  loc = new Microsoft.Maps.Location(lat, lon)
  pincode = new Microsoft.Maps.Pushpin(loc,  // create pushpin
                                       {title: memcode,
                                        color: "blue",
                                        text: 'D' } );
  map.entities.push(pincode);  // add to the map
  map.setView({center: loc});
  document.getElementById("out_hex").value = hexcode;
  document.getElementById("out_lat").value = lat.toFixed(5);
  document.getElementById("out_lon").value = lon.toFixed(5); } 

function fromLatLong() {
  clearmessage();
    lvalid = true;
    lat = parseFloat(document.getElementById("out_lat").value)
    lon = parseFloat(document.getElementById("out_lon").value)
    if (isNaN(lat)) {document.getElementById("out_err").value = "Latitude invalid";
		     lvalid = false;}
    if (isNaN(lon)) {document.getElementById("out_err").value = "Longitude invalid";
		     lvalid = false;}
    if (lon >= 180.0) {lon -= 360.0}
    if (lon < -180.0) {document.getElementById("out_err").value = "Longitude invalid";
		       lvalid = false;}
    if (lon > 180.0)  {document.getElementById("out_err").value = "Longitude invalid";
		       lvalid = false;}
    if (lat < -90.0) {document.getElementById("out_err").value = "Latitude invalid";
		       lvalid = false;}
    if (lat > 90.0) {document.getElementById("out_err").value = "Latitude invalid";
		       lvalid = false;}
    if (lvalid) {encode(lat, lon);
                 valid = true;
                 putmem();
                 document.getElementById("out_hex").value = hexcode; 
	  	 document.getElementById("out_lat").value = lat.toFixed(5);
	  	 document.getElementById("out_lon").value = lon.toFixed(5);}
    }

function fromMemCode() {
  clearmessage();
  buildmem();
  decode(memcode);
  document.getElementById("out_hex").value = hexcode;
  document.getElementById("out_lat").value = lat.toFixed(5);
  document.getElementById("out_lon").value = lon.toFixed(5); }

function fromHexCode() {
  clearmessage();
  hexcode = document.getElementById("out_hex").value 
  hextomem(hexcode);
  putmem();
  decode(memcode);
  document.getElementById("out_lat").value = lat.toFixed(5);
  document.getElementById("out_lon").value = lon.toFixed(5); }

function getLocation() {
  if (navigator.geolocation) {navigator.geolocation.getCurrentPosition(putPos, showError);} 
  else {x.innerHTML = "Geolocation is not supported by this browser.";} }
function showError(error) {
  switch(error.code) {
    case error.PERMISSION_DENIED:
      x.innerHTML = "User denied the request for Geolocation."
      break;
    case error.POSITION_UNAVAILABLE:
      x.innerHTML = "Location information is unavailable."
      break;
    case error.TIMEOUT:
      x.innerHTML = "The request to get user location timed out."
      break;
    case error.UNKNOWN_ERROR:
      x.innerHTML = "An unknown error occurred."
      break; } }
	
function putPos(position) {
  clearmessage();
  found = true;
  document.getElementById("out_lat").value = position.coords.latitude.toFixed(5);
  document.getElementById("out_lon").value = position.coords.longitude.toFixed(5);
  encode(position.coords.latitude, position.coords.longitude);
  putmem();
  document.getElementById("out_hex").value = hexcode;
  try {map.entities.remove(pinme);} // delete old pin if it exists
  catch {}
  loc = new Microsoft.Maps.Location(document.getElementById("out_lat").value, 
                                    document.getElementById("out_lon").value)
  pinme = new Microsoft.Maps.Pushpin(loc,  // create pushpin
                                     {title: memcode,
                                      color: "red",
                                      text: 'M' } );
  map.entities.push(pinme);  // put on map
  map.setView({center: loc,  //Recentre map to my location
               zoom: 10 }); }

function ft1() {if (document.getElementById("t1").value.length == 3) {check(document.getElementById("t1").value);
								      document.getElementById("t2").focus(); } }
function ft2() {if (document.getElementById("t2").value.length == 3) {check(document.getElementById("t2").value);
								      document.getElementById("t3").focus(); } }
function ft3() {if (document.getElementById("t3").value.length == 3) {check(document.getElementById("t3").value);
								      document.getElementById("t4").focus(); } }
function ft4() {if (document.getElementById("t4").value.length == 3) {check(document.getElementById("t4").value);
								      document.getElementById("t5").focus(); } }
function ft5() {if (document.getElementById("t5").value.length == 3) {check(document.getElementById("t5").value);
								      document.getElementById("t6").focus(); } }
function ft6() {if (document.getElementById("t6").value.length == 3) {check(document.getElementById("t6").value); } }

function check(tex) {     
  for (let j = 0; j < 256; j++) {if (tex.toLowerCase() == words[j]) {return;} }
  document.getElementById("out_err").value = "Word not found"; }
</script>
	
<script type='text/javascript'> // functions for coding and decoding
const words = ["ace","act","add","age", "aid","aim","air","all",
               "and","ant","ape","arm", "art","ash","ask","ate",
               "bad","bag","bar","bat", "bay","bed","beg","bet",
               "bid","big","bin","bit", "box","boy","bun","bus",
               "can","cap","car","cat", "cod","cot","cow","cry",
               "cup","cut","dab","day", "den","did","dim","dip",
               "dog","don","dry","dug", "ear","eat","egg","elf",
               "eel","end","eve","fan", "far","fat","fed","fee",

               "fen","few","fig","fin", "fit","fix","fly","fog",
               "for","fox","fry","fun", "gap","gas","get","gin",
               "got","gum","gym","had", "ham","has","hat","hay",
               "hem","hen","hid","him", "hip","hit","hog","hop",
               "hot","how","hub","hug", "hum","hut","ice","ill",
               "imp","ink","jam","jar", "jaw","jay","jet","job",
               "jog","joy","jug","key", "kid","kit","lab","lad",
               "lag","lap","law","lay", "leg","let","lid","lie",

               "lip","lit","log","lot", "low","mad","man","map",
               "mat","may","men","mix", "mob","mop","mud","mug",
               "nap","net","new","nip", "nod","not","now","nut",
               "oak","odd","off","oil", "old","one","orb","our",
               "out","owe","owl","own", "pad","pan","pat","paw",
               "pay","peg","pen","pet", "pin","pit","pod","pop",
               "pot","pub","pun","put", "rag","ram","ran","rap",
               "rat","raw","ray","red", "rib","rid","rig","rim",

               "rip","rob","rod","rot", "rub","rug","rum","run",
               "sad","sag","sap","sat", "saw","say","set","she",
               "shy","sin","sip","sir", "sit","six","ski","sky",
               "sly","spy","sum","sun", "tab","tag","tan","tap",
               "tar","tax","tea","ten", "the","tie","tin","tip",
               "tom","top","toy","try", "tub","use","van","vat",
               "vet","war","was","wax", "way","web","who","why",
               "wig","win","wit","yes", "yet","you","zip","zoo"];

function encode(lat, lon) { // assumes lat and long are valid floats
    if (lon >= 180.0) {lon -= 360.0}
    x = (lon + 180.0) / 90.0;
    y = (lat +  90.0) / 60.0;
    xi = Math.floor(x)%4;
    x -= Math.floor(x);
    if (xi == 0) {q = "2"} // q is the QuadCode
    else if (xi == 1) {q = "0"}
    else if (xi == 2) {q = "1"}
    else {q = "3"}
    if (y < 1.0) 
       {q = q + "0";
        t = "ts"; }
    else if (y >= 2.0) 
       {q = q + "3";
        y -= 2.0;
        t = "tn"; }
    else 
       {x = 2.0*x;
        xi = Math.floor(x) + 1;
        q = q + xi.toString();    
        x -= Math.floor(x);
        y -= 1.0;
        t = "q"; }
    for (let i = 0; i < 22; i++) { // code the remaining 22 digits
        if (t == "ts") 
           {if (y < 0.5) 
               {y = 2.0*y;
                q = q + "0"; }
            else 
               {x = 3.0*x;
                y = 2.0*y - 1.0;
                xi = Math.floor(x) + 1;
                q = q + xi.toString();
                x -= Math.floor(x);
                t = "q"; } }
        else if (t == "tn") 
           {if (y >= 0.5) 
               {y = 2.0*y - 1.0;
                q = q + "3"; }
            else 
               {x = 3.0*x;
                y = 2.0*y;
                xi = Math.floor(x);
                q = q + xi.toString();
                x -= Math.floor(x);
                t = "q"; } }
        else 
           {x = 2.0*x;
            y = 2.0*y;
            ci = Math.floor(x) + 2*Math.floor(y);
            q = q + ci.toString();
            x -= Math.floor(x);
            y -= Math.floor(y); } }
    hexcode = quadtohex(q);
    memcode = hextomem(hexcode); }
	
function decode(memcode) {
    putmessage(memcode);
    hexcode = memtohex(memcode);
    q = hextoquad(hexcode);
    q0 = q.substr(0,1);           // decode first digit
    if (q0 == "2") {x = -180.0} 
    else if (q0 == "0") {x = -90.0} 
    else if (q0 == "1") {x = 0.0} 
    else {x = 90.0} 
    xran = 90.0;
    yran = 60.0;
    q1 = parseInt(q.substr(1,1)); // decode second digit
    if (q1 == 0) {y = -90.0;
                  t = "ts"; }
    else if (q1 == 3) {y = 30.0;
                       t = "tn"; }
    else {x += 45.0*(q1 - 1);
          y = -30.0;
          xran = 45.0;
          t = "q"; }
    for (let i = 0; i < 22; i++) { // decode the remaining 22 digits
        yran = 0.5*yran;
        qi = parseInt(q.substr(2+i,1));
        if (t == "ts") 
           {if (qi == 0) 
               {}
            else 
               {xran = 30.0;
                x += xran*(qi - 1);
                y += yran;
                t = "q"; } }
        else if (t == "tn") 
                {if (qi == 3) 
                    {y += yran; }
                 else 
                    {xran = 30.0;
                     x += xran*qi;
                     t = "q"; } } 
        else 
           {xran = 0.5*xran;
            yi = Math.floor(qi / 2);
            xi = qi - 2*yi;
            y += yran*yi;
            x += xran*xi; } }
    lon = x + 0.5*xran;
    lat = y + 0.5*yran; }

function quadtohex(q)
    {hexmask = "000000000000";
     hexcode = parseInt(q, 4).toString(16);
     len = hexcode.length;
     hexcode = hexmask.substr(0,12-len) + hexcode; 
     return hexcode;}

function hextomem(hexcode)
    {memcode = "";
     for (let i = 0; i < 6; i++) 
       {num = parseInt(hexcode.substr(2*i,2),16);
        memcode += words[num];
        if (i == 0) {memcode += "."} 
        if (i == 1) {memcode += "."} 
        if (i == 2) {memcode += "-"} 
        if (i == 3) {memcode += "."} 
        if (i == 4) {memcode += "."} } 
     return memcode; } 

function memtohex(memcode)
  {hexcode = ""; // convert memcode to hexcode
   for (let i = 0; i < 6; i++) 
     {tex = memcode.substr(4*i,3).toLowerCase();
      found = false;
      for (let j = 0; j < 256; j++) 
        {if (tex == words[j]) 
          {if (j.toString(16).length == 1) {hexcode += "0"};
           hexcode += j.toString(16);
           found = true;}
        } }
   if (found) {return hexcode;}
   else {return "null";} }

function hextoquad(hexcode) {
  quadmask = "000000000000000000000000"; // convert hexcode to quadcode q
  q = parseInt(hexcode, 16).toString(4);
  len = q.length;
  q = quadmask.substr(0,24-len) + q; 
  return q}
</script>

<body>
<H2>GTHcode</H2>
Version: 1.10
<!--<p><a href="convert.html">Go to conversion page</a></p>-->
<p><button onclick="getLocation()" class="button buttonwide">Get my location</button>
   <button onclick="share()" class="button buttonnarrow">Share</button>
   <button onclick="test()" class="button buttonnarrow">Test</button></p>
<p><input class="texmem" id="t1" name="t1" oninput=ft1()> <b>.</b>
   <input class="texmem" id="t2" name="t2" oninput=ft2()> <b>.</b>
   <input class="texmem" id="t3" name="t3" oninput=ft3()> 
   <button onclick="fromMemCode()" class="button buttonwide">... get from MemCode</button><br>
   <input class="texmem" id="t4" name="t4" oninput=ft4()> <b>.</b>
   <input class="texmem" id="t5" name="t5" oninput=ft5()> <b>.</b>
   <input class="texmem" id="t6" name="t6" oninput=ft6()> 
   <button class="button buttonnarrow" onclick="putonmap()">Put on map</button></p>
<p><label for="out_hex">HexCode:</label>
    <input input class="texgen" id="out_hex" name="out_hex">
    <button onclick="fromHexCode()" class="button buttonwide">... get from HexCode</button></p>
<p><label for="out_lat">Lat, Long:</label>
    <input class="texll" id="out_lat" name="out_lat"> 
    <input class="texll" id="out_lon" name="out_lon">
    <button onclick="fromLatLong()" class="button buttonwide">... get from Lat, Long</button></p>
<p>Messages: <input type="text" id="out_err" name="out_err" style="color:red" disabled></p>
<p><b>Click on the map to show code:</b></p>
	
<div id="myMap" style="position:relative;width:100vw;height:50vh;"></div>
	
<script type="text/javascript">reporttype();</script>
</body>
</html>
